<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Do Memory Information Management Web Client</title>
    <script src="scripts/jquery-1.9.1.min.js"></script>
    <script src="scripts/jsrender.js"></script>
    <link href="scripts/lib/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <link href="scripts/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <h2>Do Memory - HTTP Client</h2>
    <ul id="info"></ul>
    <div id="infoAdd" style="display:none">
        <h2>Add Info</h2>
        <div id="parentID"></div>
        <div id="parentName"></div>
        <input id="inpText" class="input-xxlarge" type="text" placeholder="Info Text" />
        <button id="btnSave" type="submit" class="btn btn-primary">Save</button>
    </div>


    <script>

        // URL to the Task Data Web Service
        // Local: http://localhost:49993/api/info
        var serviceURL = "http://info.domemory.net/api/info";

        /* Compile markup as named templates */
        $.templates({
            titleTemplate: "<tr><td colspan=3>{{>name}}</td></tr>",
            detailTemplate: "<tr><td>{{>name}}</td><td>Released: {{>releaseYear}}</td><td>director: {{>director}}</td></tr>",
            taskTemplate: "<tr><td>{{>Id}}</td><td>{{>Name}}</td><td>{{>Description}}</td><td>{{>Status}}</td></tr>",
            infoTemplate: "<li  id='{{:ID}}'>{{:Text}}</li>"
        });

        // current selection information
        var activeInfoID = 0;

        function CheckInfoStorage() {
            // save open items in the database
            setTimeout(function () {
                console.log('Checking cursor');
                SaveOpenInfos();
                CheckInfoStorage();
            }, 10000);
        }

        function SaveOpenInfos() {

            $('input').each(function (key, value) {
                SaveInfo(this.getAttribute('data-parentID'), this.value);
            });

            $('#inptext').val("")
        }
        //  Send the new info object to the server
        function SaveInfo(parentID, Text) {
            if (!parentID)
                return;

            info = {};
            info.parentid = parentID;
            info.text = Text;

            $('#inptext').val("")

            $.when($.ajax({ url: serviceURL, data: info, type: "post", datatype: "json" }))
                .then(function (response, textstatus, xhr) {
                    // add task to the list
                    // $('#tasklist').append($.render.tasktemplate(task));
                });
        };
        // add new information on click on item
        $('#info')

            .on('hover', 'li', function () {
                $(this).css("color", "red");
            })
            .on('click', 'li', function () {
                //$('#parentName').text($(this).text());
                //$('#parentID').text($(this).attr('id'));
                //$('#inpText')
                //    .val("")
                //    .focus();
                //$('#infoAdd').show();

                // get clicked info
                var clickID = $(this).attr('id');

                if (clickID === activeInfoID) {
                    var $info = $(this);
                    var $infos = $info.find('#infos');

                    if ($infos.length == 0) {
                        var $infos = $('<ul id="infos"></lu>');
                        $infos.appendTo($info);
                    };

                    $infos.append('<li> <input class="input-xxlarge unsaved" data-parentID="' + activeInfoID + '" type="text" placeholder="Info Text" />jjjjj</li>');

                    CheckInfoStorage();
                }
                else {
                    activeInfoID = clickID;
                }

            });

        // get info and visualize
        $.when($.ajax({ url: serviceURL, data: { id: "root" }, type: "GET", contentType: "application/json;charset=utf-8" }))
         .then(function (data, textstatus, xhr) {
             // console.log(response);
             $('#info').html('<ul>' + $.render.infoTemplate(data.InfoList) + '</ul>');
         });

        // create a new task
        //$('#inpText').on('focusout', function (e)
        //{
        //    e.preventDefault();
        //    info = {};
        //    info.parentID = $('#parentID').text();
        //    info.Text = $('#inpText').val();

        //    $('#inpText').val("")

        //    $.when($.ajax({ url: "api/info", data: info, type: "POST", dataType: "json"}))
        //     .then(function (response, textstatus, xhr)
        //     {
        //         // add task to the list
        //         // $('#tasklist').append($.render.taskTemplate(task));
        //     });

        //});


        // delete task
        $('#deletetask').click(function (e) {
            e.preventDefault();
            var task = { id: 4 };

            $.when($.ajax({ url: "http://localhost:49993/api/task/4", data: task, type: "DELETE", dataType: "json" }))
             .then(function (response, textstatus, xhr) {
                 // add task to the list
                 // $('#tasklist').append($.render.taskTemplate(task));
             });

        });


    </script>
</body>
</html>
